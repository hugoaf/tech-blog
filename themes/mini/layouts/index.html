<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>{{ block "title" . }} {{ .Page.Title }} - {{ .Site.Title }}  {{ end }}</title>
        <!-- Bootstrap 4.0 -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">        <!-- Optional theme -->

        <link rel="stylesheet" href="{{ .Site.BaseURL }}css/styles.css" content-type="text/plain">
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-2 left-side">
          {{ block "sidebar" . }}{{ partial "left-sidebar.html" . }}{{ end }}
        </div>
        <div class="article col-sm-8">
          {{ block "header" . }}{{ partial "header.html" . }}{{ end }}
          <!--{{ block "breadcrumbs" . }}{{ partial "breadcrumbs.html" . }}{{end}}-->

          {{ block "main" . }}{{ end }}
          {{ block "footer" . }}{{ end }}

          <form id="search-form" class="form">
            <div class="form-group">
              <label for="searchTerm" ></label>
              <input type="text" class="form-control-lg" name="searchTerm" id="searchTerm">
              <button class="btn mb-2" id="search-button">Search</button>
            </div>
          </form>
          <div>
            <ul id="results-list"></ul>
          </div>
        </div>
        
        <div class="col-sm-2 right-side">
          {{ block "right-sidebar" . }}{{ partial "right-sidebar.html" . }}{{ end }}
        </div>
      </div>
    </div>

    <script>
      (()=>{

        let posts = [];
        fetch("{{ .Site.BaseURL }}" + "index.xml")
        .then(response => response.text())
        .then(str => (new window.DOMParser()).parseFromString(str, "text/xml"))
        .then(data => {
          let items =  data.getElementsByTagName("item");
          for (let index = 0; index < items.length; index++) {
            let post = {};
            post.title = items[index].children[0].innerHTML;
            post.link = items[index].children[1].innerHTML;
            post.desc = items[index].children[4].innerHTML;
            posts.push(post);
          }
        });

        document.getElementById("search-form").addEventListener("submit", function(event){
          event.preventDefault();
          search();
        });

        let search = () => {
            let term = document.getElementById("searchTerm").value.toLowerCase();
            let resultsList = document.getElementById("results-list");

            if ( term.length < 2){
              resultsList.innerHTML = "<p> Please Add a term to search. </p>";
              return;
            }

            terms = term.split(" ");
            let results = [];

            posts.map(post=>{
              post.finds = 0;
              for (let index = 0; index < terms.length; index++) {
                if(post.title.toLowerCase().includes(terms[index])){
                  post.finds +=5;
                }
                /*
                if(post.desc.toLowerCase().includes(terms[index])){
                  post.finds +=2;
                }
                */
                post.finds +=(post.desc.toLowerCase().match(new RegExp(terms[index], 'gi')) || []).length;
              }
              if ( post.finds > 0 ) {
                results.push(post);
              }
            })
            
            //console.log(results);
            resultsList.innerHTML = "";

            if(results.length===0) {
              resultsList.innerHTML = "<p> Sorry, Nothing found! </p>";
            }

            // sort by finds 
            results.sort((a,b)=>{
              if( a.finds > b.finds ) return -1;
              if( a.finds < b.finds ) return 1;
            });
            console.log(results);

            for (let index = 0; index < results.length; index++) {
                let li = document.createElement("li");
                let a = document.createElement('a');
                a.href = results[index].link;
                let p  = document.createElement('p');
                let title = document.createTextNode(results[index].title);         
                let desc = document.createTextNode(results[index].desc); 
                p.appendChild(desc);        
                a.appendChild(title);
                li.appendChild(a);
                li.appendChild(p);
                resultsList.appendChild(li);
            }
        }

      })();


      </script>
</body>
</html>